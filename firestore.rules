rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to validate user data structure
    function validUserData() {
      let allowedFields = [
        'email', 'createdAt', 'calmPoints', 'streak', 'urges', 'tasks', 'badges',
        'todayPicks', 'todayCompletions', 'startDate', 'startDateResets',
        'week1SetupDone', 'dailyMetrics', 'adherenceWindowDays', 'dailyQuote',
        'dailyQuoteSource', 'devDayOffset', 'dailyQuest', 'dailyQuestDone',
        'dailyMood', 'graceDayDates', 'lastStreakDayCounted', 'streakEvaluatedForDay', 'lastStreakMessage',
        'lastRolloverPrevDayEvaluated', 'rolloverBannerInfo', 'rolloverBannerDismissedDay',
        'week1Completed', 'backfillDisabledBeforeDay', 'completedWeeksWithFireworks',
        'week1Anchors', 'week1RotationApplied', 'dailyQuotes', 'hasAcceptedTerms', 'termsAcceptedAt',
        'username', 'avatar'
      ];
      
      return request.resource.data.keys().hasAll(['email', 'createdAt']) &&
             request.resource.data.keys().hasOnly(allowedFields);
    }
    
    // Rate limiting helper (basic check - 100 writes per hour per user)
    function notExceedingRateLimit() {
      return request.time > resource.data.lastWrite + duration.value(36, 's');
    }
    
    // Users collection
    match /users/{userId} {
      // Allow read only if authenticated and it's their own document
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Allow create only if authenticated, it's their own document, and data is valid
      allow create: if isAuthenticated() && 
                       isOwner(userId) && 
                       validUserData();
      
      // Allow update only if authenticated and it's their own document
      // For partial updates, check that existing email/createdAt aren't being modified
      allow update: if isAuthenticated() && 
                       isOwner(userId) &&
                       (!('email' in request.resource.data) || request.resource.data.email == resource.data.email) &&
                       (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt);
      
      // Allow delete only if it's their own document (for account deletion)
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // Deny all access to any other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
